# Override from parent directory, everything in this directory is web accessible
Allow from all

# Prevent direct directory access, however
Options -Indexes

# Hide sitemap.xml in search results
<Files sitemap.xml>
  Header set X-Robots-Tag "noindex"
</Files>

<IfModule mod_rewrite.c>
    RewriteEngine On

    # User URL's have moved from '/recipe/user/2:Peri+Moritz' to '/recipe/user/2/Peri-Moritz'
    # The %1 replacement hack references a capture group from the condition above, to include the relative path on localhost
    RewriteCond %{REQUEST_URI} ^(.*)/recipe/user/\d+:[a-zA-Z+-]+
    RewriteRule ^recipe/user/(\d+):([a-zA-Z+-]+)$ http://%{HTTP_HOST}%1/recipe/user/$1/$2 [NC,R=301,L]

    # Catch requests to the old printable.php page and direct to the current recipe page
    # The %1 capture group only references the prior RewriteCond, so we are passing the
    # first capture group into the second condition, and that into the rule
    # See: http://stackoverflow.com/a/17793597/452133
    RewriteCond %{REQUEST_URI} ^(.*)/printable\.php
    RewriteCond %1/##%{QUERY_STRING} (.*)##id=(\d+)
    RewriteRule ^printable.php$ http://%{HTTP_HOST}%1recipe/show/%2? [NC,R=301,L]

    # If a thumbnail is not found then invoke thumbnail maker
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^files/thumbnails/.*\.(jpe?g|png) thumb.php [L,NC]

    # Redirect from www subdomain to preferred domain (no-www)
    RewriteCond %{HTTP_HOST} !^(localhost$) [NC]
    RewriteCond %{HTTP_HOST} ^www [NC]
    RewriteRule ^(.*)$ http://perisplaceforrecipes.com/$1 [L,R=301]

    # Check to see if the user is attempting to access a valid file,
    # such as an image or css document, if this isn't true this sends the
    # request to index.php.
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(.*)$ index.php/$1 [L]
</IfModule>
